name: Deploy Configuration (Dev)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for local changes and create PR if needed
        id: check_changes
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: false
          script: |
            cd ~/work-track/deployment
            git fetch origin dev
            
            # Check for local changes or divergence from origin
            if ! git diff --quiet HEAD origin/dev || [ -n "$(git status --porcelain)" ]; then
              echo "Found local changes on server, creating PR..."
              
              BRANCH_NAME="server-local-changes-$(date +%s)"
              git config user.name "SergeyOhryamkin"
              git config user.email "sergey.ohryamkin@softservice.org"
              
              # Create branch with local changes
              git checkout -b "$BRANCH_NAME"
              git add -A
              git commit -m "Server local changes found during deployment
              
              These changes were found on the VPS during automated deployment.
              Please review and merge if needed, or discard if they are temporary."
              
              # Push branch to GitHub
              git push origin "$BRANCH_NAME"
              
              # Create PR using GitHub CLI
              export GH_TOKEN="${{ secrets.GITHUB_TOKEN }}"
              PR_URL=$(gh pr create --base dev --head "$BRANCH_NAME" --title "ðŸš¨ Server local changes detected during deployment" --body "Local changes found on VPS during deployment. Review and merge if needed, or close if temporary.")
              
              if [ $? -ne 0 ]; then
                echo "::error::Found local changes on server but failed to create PR. Please check manually."
                exit 1
              fi
              
              echo "PR created: $PR_URL"
              echo "::error::Found local changes on server. Resolve PR: $PR_URL"
              exit 1
            fi

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -euo pipefail
            cd ~/work-track/deployment
            git pull origin dev
            docker-compose -f docker-compose.dev.yml up -d --build
            docker-compose up -d
            docker-compose restart nginx
            docker-compose ps
